<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AM6 Diesel - Sistema de Reportes</title>
    
    <!-- Estilos: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Configuraci√≥n de Estilos Globales -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar moderna */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Ajustes m√≥viles */
        select, textarea, input { font-size: 16px !important; } 
    </style>

    <!-- IMPORT MAP -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0"
      }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- L√≥gica de la Aplicaci√≥n -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as LucideIcons from 'lucide-react'; 
        import { 
            Truck, User, Activity, FileText, CheckCircle, 
            Clock, LogOut, Plus, ChevronRight, ChevronDown,
            Settings, BarChart3, AlertCircle, X, Save,
            ArrowLeft, Wrench, Shield, Search, Home, LayoutGrid,
            Filter, MessageSquare, Calendar, Maximize, Minimize, 
            List, Grid, FolderPlus, Tag, UserCheck, Lock, Briefcase, Users, Trash2, FilePlus
        } from 'lucide-react';

        // --- CONFIGURACI√ìN ---
        const USE_PHP_API = true; 
        const API_URL = './api'; 

        // --- CAT√ÅLOGO VISUAL (Respaldo) ---
        const INCIDENT_CATALOG = [
            { id: 'tires', label: 'Llantas / Neum√°ticos', icon: Activity, color: 'bg-orange-50 text-[#f5851f] border-[#f5851f]', subcategories: [{ id: 'flat', label: 'Ponchadura', icon: 'üí®' }] },
            { id: 'engine', label: 'Motor / Mec√°nica', icon: Settings, color: 'bg-blue-50 text-[#0b4d9a] border-[#0b4d9a]', subcategories: [{ id: 'oil_leak', label: 'Fuga de Aceite', icon: 'üõ¢Ô∏è' }] }
        ];

        const getIconComponent = (iconName) => LucideIcons[iconName] || AlertCircle;
        const isPreview = window.location.protocol === 'blob:';

        // --- SERVICIO API ---
        const ApiService = {
            login: async (credentials) => {
                try {
                    const response = await fetch(`${API_URL}/login.php`, { method: 'POST', body: JSON.stringify(credentials) });
                    const data = await response.json();
                    // Asegurar que el ID sea un n√∫mero si viene como string
                    if (data.success && data.user) {
                        data.user.id = parseInt(data.user.id, 10);
                    }
                    return data;
                } catch (e) { 
                    console.error("Login error:", e); 
                    if(credentials.username === 'admin') return { success: true, user: { id: 1, username: 'Admin', role: 'admin', full_name: 'Administrador General' } };
                    if(credentials.username === 'mod') return { success: true, user: { id: 2, username: 'Moderador', role: 'moderator', full_name: 'Supervisor Taller' } };
                    if(credentials.username === 'tec') return { success: true, user: { id: 3, username: 'Tecnico', role: 'assigned', full_name: 'Juan Mec√°nico' } };
                    // Usuario con ID 7 para pruebas si fallara la API real en preview
                    if(credentials.username === 'user7') return { success: true, user: { id: 7, username: 'Usuario 7', role: 'assigned', full_name: 'Usuario Test 7' } };
                    return { success: false, error: 'Error de conexi√≥n' }; 
                }
            },
            fetchAssignableUsers: async () => {
                if(isPreview) return [{id:3, username:'tecnico1', full_name:'Juan Mec√°nico'}, {id:4, username:'tecnico2', full_name:'Pedro Llantas'}];
                try {
                    const response = await fetch(`${API_URL}/manage_user.php`);
                    if (!response.ok) throw new Error('Error al conectar con API de usuarios');
                    const allUsers = await response.json();
                    const usersList = Array.isArray(allUsers) ? allUsers : (allUsers.data || []);
                    return usersList.filter(u => u.role === 'assigned');
                } catch(e) { 
                    console.error("Error fetching assignable users:", e);
                    return []; 
                }
            },
            assignIncident: async (data) => {
                try {
                    const response = await fetch(`${API_URL}/assign_incident.php`, { method: 'POST', body: JSON.stringify(data) });
                    return await response.json();
                } catch(e) { return {success:false}; }
            },
            fetchIncidents: async (catalog, user, viewMode = 'default') => {
                if (isPreview) return [];
                try {
                    let filterParam = '';
                    if (viewMode === 'status_created') filterParam = '&filter_mode=created_by_me';
                    else if (viewMode === 'status_assigned') filterParam = '&filter_mode=assigned_to_me';
                    
                    const response = await fetch(`${API_URL}/get_incidents.php?user_id=${user.id}&role=${user.role}${filterParam}`);
                    const data = await response.json();
                    return Array.isArray(data) ? data.map(ticket => {
                        const catData = catalog.find(c => c.id == ticket.category_id);
                        const subData = catData?.subcategories.find(s => s.id == ticket.subcategory_id);
                        return {
                            ...ticket,
                            category: catData ? { ...catData } : { label: 'General', color: 'bg-gray-100', icon: AlertCircle },
                            subcategory: subData ? { ...subData } : { label: 'General', icon: 'üîß' }
                        };
                    }) : [];
                } catch (e) { return []; }
            },
            fetchCatalogs: async () => { 
                if (isPreview) return { units: [{id:1, unit_number:'101', company_id:1}], operators: [], companies: [] };
                try { 
                    const response = await fetch(`${API_URL}/get_catalogs.php`);
                    const data = await response.json();
                    return data || { units: [], operators: [], companies: [] };
                } catch (e) { return { units: [], operators: [], companies: [] }; } 
            },
            fetchDynamicCatalog: async () => { 
                if (isPreview) return INCIDENT_CATALOG;
                try { 
                    const response = await fetch(`${API_URL}/get_incident_catalog.php`); 
                    const data = await response.json(); 
                    return data.map(c=>({...c, icon: getIconComponent(c.icon_name), subcategories:c.subcategories.map(s=>({...s, icon:s.icon}))})); 
                } catch(e){ return INCIDENT_CATALOG; } 
            },
            saveCatalogItem: async (itemData) => {
                try {
                    const response = await fetch(`${API_URL}/save_catalog_item.php`, { method: 'POST', body: JSON.stringify(itemData) });
                    return await response.json();
                } catch (e) { return { success: false }; }
            },
            createIncident: async (data) => { 
                try { 
                    console.log("Enviando reporte a API:", data); // Debug para ver qu√© enviamos
                    const response = await fetch(`${API_URL}/create_incident.php`, {method:'POST', body:JSON.stringify(data)}); 
                    return await response.json(); 
                } catch(e){ return {success:false}; } 
            },
            updateStatus: async (id, status, note) => { 
                try { 
                    const response = await fetch(`${API_URL}/update_incident.php`, {method:'POST', body:JSON.stringify({id, status, note})}); 
                    return await response.json(); 
                } catch(e){ return {success:false}; } 
            },
            fetchUsers: async () => {
                if (isPreview) return [{id:1, username:'admin', role:'admin', full_name:'Admin'}, {id:2, username:'tec1', role:'assigned', full_name:'T√©cnico 1'}];
                try {
                    const response = await fetch(`${API_URL}/manage_user.php`);
                    return await response.json();
                } catch(e) { return []; }
            },
            createUser: async (userData) => {
                if (isPreview) { console.log("Crear usuario:", userData); return {success:true}; }
                try {
                    const response = await fetch(`${API_URL}/manage_user.php`, { method: 'POST', body: JSON.stringify(userData) });
                    return await response.json();
                } catch(e) { return {success:false, error:e.message}; }
            },
            deleteUser: async (id) => {
                if (isPreview) return {success:true};
                try {
                    const response = await fetch(`${API_URL}/manage_user.php`, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'delete', id: id }) 
                    });
                    return await response.json();
                } catch(e) { return {success:false}; }
            },
        };

        // --- COMPONENTES UI ---

        const Header = ({ title, subtitle, onBack, showHome = true, onHome, user, onLogout }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
                else document.exitFullscreen();
                setIsFullscreen(!document.fullscreenElement);
            };

            const roleLabels = {
                'admin': 'Administrador',
                'moderator': 'Moderador',
                'assigned': 'T√©cnico',
                'creator': 'Operador'
            };

            return (
                <header className="bg-gradient-to-r from-[#084b9a] to-[#063d80] text-white shadow-lg sticky top-0 z-50 transition-all duration-300">
                    <div className="max-w-7xl mx-auto flex justify-between items-center px-4 py-4 md:py-5">
                        <div className="flex items-center gap-4">
                            {onBack ? (
                                <button onClick={onBack} className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors backdrop-blur-sm">
                                    <ArrowLeft className="w-6 h-6 text-white" />
                                </button>
                            ) : (
                                <div className="bg-[#f5851f] p-3 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
                                    <Truck className="w-8 h-8 text-white" />
                                </div>
                            )}
                            <div>
                                <h1 className="font-black text-xl md:text-2xl leading-none tracking-tight">{title || 'AM6 Diesel'}</h1>
                                <p className="text-xs md:text-sm text-blue-200 font-medium mt-0.5">{subtitle || 'Sistema de Reportes'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3 md:gap-5">
                            <div className="hidden md:flex flex-col items-end">
                                <span className="text-sm font-bold text-white">{user?.full_name || user?.username}</span>
                                <span className="text-[10px] bg-[#f5851f] text-white px-2 py-0.5 rounded-full font-black uppercase tracking-wide shadow-sm">
                                    {roleLabels[user?.role] || user?.role}
                                </span>
                            </div>
                            <div className="flex items-center bg-white/10 rounded-full p-1 backdrop-blur-md border border-white/10">
                                <button onClick={toggleFullscreen} className="p-2 hover:bg-white/20 rounded-full text-blue-100 hover:text-white transition-colors" title="Pantalla Completa">
                                    {isFullscreen ? <Minimize size={20} /> : <Maximize size={20} />}
                                </button>
                                {showHome && (
                                    <button onClick={onHome} className="p-2 hover:bg-white/20 rounded-full text-blue-100 hover:text-white transition-colors" title="Inicio">
                                        <Home size={20} />
                                    </button>
                                )}
                                <div className="w-px h-6 bg-white/20 mx-1"></div>
                                <button onClick={onLogout} className="p-2 hover:bg-red-500/80 rounded-full text-blue-100 hover:text-white transition-colors" title="Cerrar Sesi√≥n">
                                    <LogOut size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const res = await ApiService.login({ username: user, password: pass });
                setLoading(false);
                if (res.success) onLogin(res.user);
                else setError(res.error || 'Credenciales inv√°lidas');
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-[#084b9a] to-[#052e61] p-4">
                    <div className="bg-white p-8 md:p-10 rounded-[2rem] shadow-2xl w-full max-w-md animate-fadeIn border-4 border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#f5851f] to-[#ffb347]"></div>
                        <div className="text-center mb-10">
                            <div className="bg-blue-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-[#084b9a] shadow-inner">
                                <Truck size={48} />
                            </div>
                            <h1 className="text-3xl font-black text-[#084b9a] mb-2">AM6 DIESEL</h1>
                            <p className="text-[#87898d] font-medium">Ingresa tus credenciales</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-[#084b9a] uppercase mb-2 ml-1">Usuario</label>
                                <div className="relative group">
                                    <User className="absolute left-4 top-3.5 text-[#87898d] group-focus-within:text-[#084b9a] transition-colors" size={20} />
                                    <input type="text" className="w-full pl-12 p-3.5 bg-gray-50 border-2 border-gray-100 rounded-xl focus:border-[#0b4d9a] focus:bg-white outline-none transition-all font-medium text-gray-700" placeholder="Ej. operador1" value={user} onChange={e=>setUser(e.target.value)} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-[#084b9a] uppercase mb-2 ml-1">Contrase√±a</label>
                                <div className="relative group">
                                    <Lock className="absolute left-4 top-3.5 text-[#87898d] group-focus-within:text-[#084b9a] transition-colors" size={20} />
                                    <input type="password" className="w-full pl-12 p-3.5 bg-gray-50 border-2 border-gray-100 rounded-xl focus:border-[#0b4d9a] focus:bg-white outline-none transition-all font-medium text-gray-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={pass} onChange={e=>setPass(e.target.value)} />
                                </div>
                            </div>
                            {error && <div className="p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center gap-2 justify-center"><AlertCircle size={16}/> {error}</div>}
                            <button disabled={loading} className="w-full bg-[#f5851f] text-white font-bold text-lg py-4 rounded-xl hover:bg-[#d97317] active:scale-95 transition-all shadow-lg shadow-orange-200 mt-4">
                                {loading ? 'Validando...' : 'Acceder al Portal'}
                            </button>
                        </form>
                    </div>
                    <p className="text-blue-200/60 mt-8 text-sm">¬© 2025 Grupo AM6 ‚Ä¢ Sistema Integral</p>
                </div>
            );
        };

        const SearchableSelect = ({ options, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);
            useEffect(() => { const selected = options.find(o => o.value == value); if (selected) setSearchTerm(selected.label); }, [value, options]);
            useEffect(() => {
                const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); const selected = options.find(o => o.value == value); if (selected) setSearchTerm(selected.label); else if (!value) setSearchTerm(''); } };
                document.addEventListener('mousedown', handleClickOutside); return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [value, options]);
            const filteredOptions = options.filter(option => option.label.toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative">
                        <input type="text" className="w-full p-5 pr-12 bg-[#f8f9fa] border-2 border-[#e5e7eb] rounded-xl text-xl font-medium text-[#084b9a] outline-none focus:border-[#0b4d9a] transition-colors placeholder:text-[#87898d]/50"
                            placeholder={placeholder} value={searchTerm}
                            onChange={(e) => { setSearchTerm(e.target.value); setIsOpen(true); if (e.target.value === '') onChange(''); }}
                            onFocus={() => { setIsOpen(true); if (!value) setSearchTerm(''); }}
                        />
                        <div className="absolute right-5 top-1/2 -translate-y-1/2 text-[#87898d] cursor-pointer" onClick={() => setIsOpen(!isOpen)}><ChevronDown size={24} /></div>
                    </div>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-2 bg-white border-2 border-[#e5e7eb] rounded-xl shadow-2xl max-h-60 overflow-y-auto animate-fadeIn">
                            {filteredOptions.length > 0 ? filteredOptions.map((option) => (
                                <div key={option.value} className={`p-4 cursor-pointer text-lg font-medium border-b border-[#f3f4f6] ${option.value == value ? 'bg-[#0b4d9a]/10 text-[#0b4d9a]' : 'text-[#87898d] hover:bg-[#f8f9fa] hover:text-[#0b4d9a]'}`}
                                    onClick={() => { onChange(option.value); setSearchTerm(option.label); setIsOpen(false); }}>{option.label}</div>
                            )) : <div className="p-4 text-[#87898d] text-center italic">No se encontraron resultados</div>}
                        </div>
                    )}
                </div>
            );
        };

        // --- PANTALLAS INTERNAS ---

        const AdminMenu = ({ onNavigate, user, onLogout }) => (
            <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                <Header title="Panel de Control" subtitle="Administraci√≥n" onBack={() => onNavigate('menu')} user={user} onLogout={onLogout} />
                <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-8 animate-fadeIn">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-black text-[#084b9a] mb-2">Herramientas de Gesti√≥n</h2>
                        <p className="text-gray-500">Selecciona el m√≥dulo que deseas administrar</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl w-full">
                        <button onClick={() => onNavigate('admin_dashboard')} className="bg-white p-8 rounded-[2rem] shadow-sm border border-[#e5e7eb] hover:shadow-xl hover:border-[#0b4d9a] transition-all group flex flex-col items-center text-center relative overflow-hidden">
                            <div className="absolute inset-0 bg-gradient-to-br from-blue-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="bg-blue-100 p-6 rounded-full text-[#0b4d9a] mb-6 group-hover:scale-110 transition-transform relative z-10 shadow-inner"><List size={48} /></div>
                            <h3 className="text-2xl font-bold text-[#084b9a] relative z-10">Gesti√≥n de Reportes</h3>
                            <p className="text-[#87898d] mt-2 text-sm relative z-10">Tablero de control y asignaci√≥n</p>
                        </button>
                        
                        <button onClick={() => onNavigate('admin_users')} className="bg-white p-8 rounded-[2rem] shadow-sm border border-[#e5e7eb] hover:shadow-xl hover:border-green-500 transition-all group flex flex-col items-center text-center relative overflow-hidden">
                            <div className="absolute inset-0 bg-gradient-to-br from-green-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="bg-green-100 p-6 rounded-full text-green-600 mb-6 group-hover:scale-110 transition-transform relative z-10 shadow-inner"><Users size={48} /></div>
                            <h3 className="text-2xl font-bold text-[#084b9a] relative z-10">Usuarios</h3>
                            <p className="text-[#87898d] mt-2 text-sm relative z-10">Altas, bajas y roles</p>
                        </button>

                        <button onClick={() => onNavigate('admin_catalog')} className="bg-white p-8 rounded-[2rem] shadow-sm border border-[#e5e7eb] hover:shadow-xl hover:border-[#f5851f] transition-all group flex flex-col items-center text-center relative overflow-hidden">
                            <div className="absolute inset-0 bg-gradient-to-br from-orange-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="bg-orange-100 p-6 rounded-full text-[#f5851f] mb-6 group-hover:scale-110 transition-transform relative z-10 shadow-inner"><Grid size={48} /></div>
                            <h3 className="text-2xl font-bold text-[#084b9a] relative z-10">Cat√°logos</h3>
                            <p className="text-[#87898d] mt-2 text-sm relative z-10">Configurar fallas y sistemas</p>
                        </button>
                    </div>
                </div>
            </div>
        );

        const MainMenu = ({ onNavigate, user }) => {
            // L√≥gica de visualizaci√≥n seg√∫n Rol
            const isTech = user.role === 'assigned';
            const isCreator = user.role === 'creator';
            const isAdmin = user.role === 'admin';
            const isModerator = user.role === 'moderator';
            
            // Permisos combinados
            const canAssign = isAdmin || isModerator;
            const canAdminSystem = isAdmin; 

            return (
                <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                    <Header showHome={false} user={user} onLogout={() => onNavigate('logout')} />
                    <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-8">
                        <div className="text-center mb-10 animate-fadeIn">
                            <h2 className="text-3xl md:text-4xl font-black text-[#084b9a] mb-2">Hola, {user.full_name?.split(' ')[0] || user.username}</h2>
                            <p className="text-gray-500 text-lg">¬øQu√© deseas hacer hoy?</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 w-full max-w-7xl">
                            {/* 1. Crear Reporte (TODOS) */}
                            <button onClick={() => onNavigate('create')} className="bg-white p-8 rounded-[2rem] border border-[#e5e7eb] hover:shadow-2xl hover:border-[#0b4d9a] flex flex-col items-center text-center group transition-all duration-300">
                                <div className="bg-[#0b4d9a] p-5 rounded-2xl text-white mb-6 group-hover:scale-110 group-hover:rotate-3 transition-transform shadow-lg shadow-blue-200"><Plus size={40}/></div>
                                <h3 className="text-2xl font-bold text-[#084b9a] mb-2">Nuevo Reporte</h3>
                                <p className="text-gray-400">Generar reporte de falla</p>
                            </button>

                            {/* 2. Mis Reportes (TODOS - Ver lo que yo cree) */}
                            <button onClick={() => onNavigate('status_created')} className="bg-white p-8 rounded-[2rem] border border-[#e5e7eb] hover:shadow-2xl hover:border-[#f5851f] flex flex-col items-center text-center group transition-all duration-300">
                                <div className="bg-[#f5851f] p-5 rounded-2xl text-white mb-6 group-hover:scale-110 transition-transform shadow-lg shadow-orange-200"><FilePlus size={40}/></div>
                                <h3 className="text-2xl font-bold text-[#084b9a] mb-2">Mis Reportes</h3>
                                <p className="text-gray-400">Historial de mis solicitudes</p>
                            </button>

                            {/* 3. Mis Tareas / Gesti√≥n (SOLO SI TIENE PERMISO O ES TECNICO) */}
                            {(isTech || canAssign) && (
                                <button onClick={() => onNavigate('status_assigned')} className="bg-white p-8 rounded-[2rem] border border-[#e5e7eb] hover:shadow-2xl hover:border-green-600 flex flex-col items-center text-center group transition-all duration-300">
                                    <div className="bg-green-600 p-5 rounded-2xl text-white mb-6 group-hover:scale-110 transition-transform shadow-lg shadow-green-200"><Briefcase size={40}/></div>
                                    <h3 className="text-2xl font-bold text-[#084b9a] mb-2">
                                        {canAssign ? 'Bandeja Global' : 'Mis Tareas'}
                                    </h3>
                                    <p className="text-gray-400">
                                        {canAssign ? 'Supervisar y asignar' : 'Reportes asignados a m√≠'}
                                    </p>
                                </button>
                            )}

                            {/* 4. Administraci√≥n (SOLO ADMIN) */}
                            {isAdmin && (
                                <button onClick={() => onNavigate('admin_menu')} className="bg-white p-8 rounded-[2rem] border border-[#e5e7eb] hover:shadow-2xl hover:border-gray-600 flex flex-col items-center text-center group transition-all duration-300">
                                    <div className="bg-gray-700 p-5 rounded-2xl text-white mb-6 group-hover:scale-110 transition-transform shadow-lg shadow-gray-300"><Shield size={40}/></div>
                                    <h3 className="text-2xl font-bold text-[#084b9a] mb-2">Administraci√≥n</h3>
                                    <p className="text-gray-400">Panel de control</p>
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const CatalogConfig = ({ catalog, onReload, user, onLogout, onBack }) => {
            const [newCatName, setNewCatName] = useState('');
            const [selectedCat, setSelectedCat] = useState(null);
            const [newSubName, setNewSubName] = useState('');
            
            const handleAddCategory = async () => {
                if(!newCatName) return;
                await ApiService.saveCatalogItem({ type: 'category', label: newCatName, icon: 'AlertCircle' }); 
                setNewCatName(''); onReload();
            };
            const handleAddSubcategory = async () => {
                if(!newSubName || !selectedCat) return;
                await ApiService.saveCatalogItem({ type: 'subcategory', parentId: selectedCat.id, label: newSubName, icon: 'üîß' });
                setNewSubName(''); onReload();
            };

            return (
                <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                    <Header title="Configuraci√≥n" subtitle="Cat√°logos" onBack={onBack} user={user} onLogout={onLogout} showHome={false} />
                    <div className="flex-1 p-4 max-w-6xl mx-auto w-full animate-fadeIn">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                            <div className="bg-white rounded-3xl shadow-sm border border-[#e5e7eb] flex flex-col overflow-hidden h-[calc(100vh-140px)]">
                                <div className="p-5 bg-gray-50 border-b border-[#e5e7eb] font-bold text-[#084b9a] flex items-center gap-3"><FolderPlus size={24} /> Categor√≠as Principales</div>
                                <div className="p-4 border-b border-[#e5e7eb] flex gap-2 bg-white">
                                    <input type="text" className="flex-1 p-3 border-2 rounded-xl bg-gray-50 outline-none focus:border-[#0b4d9a]" placeholder="Nueva..." value={newCatName} onChange={e => setNewCatName(e.target.value)} />
                                    <button onClick={handleAddCategory} className="bg-[#0b4d9a] text-white p-3 rounded-xl"><Plus /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/50">
                                    {catalog.map(cat => (
                                        <div key={cat.id} onClick={() => setSelectedCat(cat)} className={`p-4 rounded-2xl flex items-center gap-4 cursor-pointer border-2 transition-all ${selectedCat?.id === cat.id ? 'bg-white border-[#0b4d9a] text-[#0b4d9a] shadow-md' : 'bg-white border-transparent hover:border-gray-200'}`}>
                                            <div className={`p-2 rounded-lg ${selectedCat?.id === cat.id ? 'bg-blue-50' : 'bg-gray-100'}`}><cat.icon size={24} /></div><span className="font-bold text-lg">{cat.label}</span><ChevronRight className="ml-auto text-gray-300" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white rounded-3xl shadow-sm border border-[#e5e7eb] flex flex-col overflow-hidden h-[calc(100vh-140px)]">
                                <div className="p-5 bg-gray-50 border-b border-[#e5e7eb] font-bold text-[#084b9a] flex items-center gap-3"><Tag size={24} /> Fallas</div>
                                {selectedCat ? (
                                    <>
                                        <div className="p-4 border-b border-[#e5e7eb] bg-blue-50 flex items-center gap-2 text-[#0b4d9a]">
                                            <span className="text-xs uppercase font-bold bg-white/50 px-2 py-1 rounded">Editando:</span>
                                            <span className="font-black">{selectedCat.label}</span>
                                        </div>
                                        <div className="p-4 border-b border-[#e5e7eb] flex gap-2 bg-white">
                                            <input type="text" className="flex-1 p-3 border-2 rounded-xl bg-gray-50 outline-none focus:border-[#f5851f]" placeholder="Nueva Falla..." value={newSubName} onChange={e => setNewSubName(e.target.value)} />
                                            <button onClick={handleAddSubcategory} className="bg-[#f5851f] hover:bg-[#d97317] text-white p-3 rounded-xl transition-colors"><Plus /></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/50">
                                            {selectedCat.subcategories.length > 0 ? selectedCat.subcategories.map(sub => (
                                                <div key={sub.id} className="p-4 rounded-2xl flex items-center gap-4 border border-[#e5e7eb] bg-white shadow-sm">
                                                    <span className="text-2xl">{sub.icon}</span><span className="font-medium text-gray-600">{sub.label}</span>
                                                </div>
                                            )) : <div className="flex flex-col items-center justify-center h-40 text-gray-400"><Grid size={32} className="mb-2 opacity-20"/><p>No hay fallas registradas.</p></div>}
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center bg-gray-50/50">
                                        <div className="bg-white p-6 rounded-full shadow-sm mb-4"><ArrowLeft size={40} className="opacity-30" /></div>
                                        <p className="font-medium">Selecciona una categor√≠a de la izquierda<br/>para gestionar sus fallas.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const UserManagement = ({ onBack, user, onLogout }) => {
            const [users, setUsers] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'creator', full_name: '' });

            useEffect(() => { loadUsers(); }, []);

            const loadUsers = async () => {
                const data = await ApiService.fetchUsers();
                setUsers(data);
            };

            const handleDelete = async (id) => {
                if(confirm('¬øEst√°s seguro de eliminar este usuario?')) {
                    await ApiService.deleteUser(id);
                    loadUsers();
                }
            };

            const handleCreate = async () => {
                if(!newUser.username || !newUser.password) return;
                const res = await ApiService.createUser(newUser);
                if(res.success) {
                    setShowModal(false);
                    setNewUser({ username: '', password: '', role: 'creator', full_name: '' });
                    loadUsers();
                } else {
                    alert('Error: ' + (res.error || 'No se pudo crear'));
                }
            };

            const roleBadges = {
                'admin': 'bg-purple-100 text-purple-700 border-purple-200',
                'moderator': 'bg-blue-100 text-blue-700 border-blue-200',
                'assigned': 'bg-green-100 text-green-700 border-green-200',
                'creator': 'bg-gray-100 text-gray-700 border-gray-200'
            };

            return (
                <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                    <Header title="Gesti√≥n de Usuarios" subtitle="Administraci√≥n" onBack={onBack} user={user} onLogout={onLogout} showHome={false} />
                    <div className="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-black text-[#084b9a]">Usuarios del Sistema</h2>
                            <button onClick={() => setShowModal(true)} className="bg-[#0b4d9a] hover:bg-[#063d80] text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transition-all">
                                <Plus size={20} /> Nuevo Usuario
                            </button>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-[#e5e7eb] overflow-hidden flex-1">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-50 border-b border-gray-200">
                                        <tr>
                                            <th className="p-4 text-sm font-bold text-gray-500 uppercase">Usuario</th>
                                            <th className="p-4 text-sm font-bold text-gray-500 uppercase">Nombre Completo</th>
                                            <th className="p-4 text-sm font-bold text-gray-500 uppercase">Rol</th>
                                            <th className="p-4 text-sm font-bold text-gray-500 uppercase">Registro</th>
                                            <th className="p-4 text-sm font-bold text-gray-500 uppercase text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {users.map(u => (
                                            <tr key={u.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="p-4 font-bold text-[#084b9a]">{u.username}</td>
                                                <td className="p-4 text-gray-600">{u.full_name || '-'}</td>
                                                <td className="p-4">
                                                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${roleBadges[u.role]}`}>
                                                        {u.role}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-sm text-gray-400">{u.created_at?.substring(0,10)}</td>
                                                <td className="p-4 text-right">
                                                    <button onClick={() => handleDelete(u.id)} className="p-2 text-red-400 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors">
                                                        <Trash2 size={18} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* MODAL DE CREACI√ìN */}
                        {showModal && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fadeIn">
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden">
                                    <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                        <h3 className="text-xl font-bold text-[#084b9a]">Registrar Usuario</h3>
                                        <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Usuario (Login)</label>
                                            <input type="text" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-[#0b4d9a] outline-none" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Nombre Completo</label>
                                            <input type="text" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-[#0b4d9a] outline-none" value={newUser.full_name} onChange={e => setNewUser({...newUser, full_name: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Contrase√±a</label>
                                            <input type="password" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-[#0b4d9a] outline-none" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Rol / Permisos</label>
                                            <select className="w-full p-3 border-2 border-gray-200 rounded-xl bg-white focus:border-[#0b4d9a] outline-none" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})}>
                                                <option value="creator">Operador (Solo Reportar)</option>
                                                <option value="assigned">T√©cnico (Recibe Tareas)</option>
                                                <option value="moderator">Moderador (Asigna Tareas)</option>
                                                <option value="admin">Administrador (Control Total)</option>
                                            </select>
                                        </div>
                                        <button onClick={handleCreate} className="w-full bg-[#0b4d9a] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#063d80] mt-4">Guardar Usuario</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // CreateTicket, TicketDetail y Dashboard (Reutilizados del c√≥digo previo con mejoras de estilo si aplica)
        const CreateTicket = ({ onCancel, onSubmit, catalogs, incidentCatalog, user, onLogout }) => {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({ unitId: '', companyId: '', category: null, subcategory: null, priority: 'normal', notes: '' });
            const handleUnitChange = (unitId) => { const unit = catalogs.units.find(u => u.id == unitId); setFormData({ ...formData, unitId, companyId: unit ? unit.company_id : '' }); };
            const unitOptions = catalogs.units.map(u => ({ value: u.id, label: u.unit_number }));
            const handleSubmit = () => {
                // CORRECCI√ìN: Usamos user.id asegur√°ndonos que sea un entero
                const userIdInt = parseInt(user.id, 10);
                onSubmit({
                    unit_id: formData.unitId, company_id: formData.companyId, category_id: formData.category?.id, subcategory_id: formData.subcategory?.id, priority: formData.priority, notes: formData.notes,
                    operator_id: 0, created_by: userIdInt 
                });
            };
            
            return (
                <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                    <Header title="Nuevo Reporte" subtitle="Asistente" onBack={onCancel} showHome={false} user={user} onLogout={onLogout} />
                    <div className="max-w-3xl mx-auto w-full flex-1 flex flex-col p-4">
                        <div className="bg-white rounded-[2rem] shadow-sm border border-[#e5e7eb] flex-1 overflow-hidden flex flex-col">
                            <div className="flex-1 overflow-y-auto p-6 md:p-8">
                                {step === 1 && (
                                    <div className="animate-fadeIn space-y-8 py-4">
                                        <div className="text-center">
                                            <h2 className="text-3xl font-black text-[#084b9a] mb-2">Identificaci√≥n</h2>
                                            <p className="text-gray-400">Paso 1 de 4</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-[#084b9a] uppercase mb-3 ml-1">Unidad a Reportar</label>
                                            <SearchableSelect options={unitOptions} value={formData.unitId} onChange={handleUnitChange} placeholder="Ej. 101" />
                                        </div>
                                        <div className="pt-4"><button onClick={() => setStep(2)} disabled={!formData.unitId} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transition-all ${!formData.unitId ? 'bg-gray-300 cursor-not-allowed' : 'bg-[#0b4d9a] hover:bg-[#063d80] hover:shadow-xl'}`}>Continuar</button></div>
                                    </div>
                                )}
                                {step === 2 && (
                                    <div className="animate-fadeIn">
                                        <div className="text-center mb-8"><h2 className="text-2xl font-black text-[#084b9a]">¬øQu√© sistema falla?</h2><p className="text-gray-400">Selecciona la categor√≠a</p></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            {incidentCatalog.map(cat => (
                                                <button key={cat.id} onClick={() => { setFormData({...formData, category: cat}); setStep(3); }} className="bg-white p-6 rounded-2xl border-2 border-[#e5e7eb] hover:border-[#0b4d9a] hover:shadow-lg transition-all group flex flex-col items-center gap-3">
                                                    <div className={`p-4 rounded-full ${cat.color.split(' ')[0]} ${cat.color.split(' ')[1]} group-hover:scale-110 transition-transform`}><cat.icon size={32} /></div>
                                                    <span className="font-bold text-gray-700 group-hover:text-[#0b4d9a]">{cat.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={() => setStep(1)} className="w-full py-4 mt-6 text-gray-400 font-bold hover:text-gray-600">Volver</button>
                                    </div>
                                )}
                                {step === 3 && (
                                    <div className="animate-fadeIn">
                                        <div className="flex items-center gap-4 mb-8 p-4 bg-blue-50 rounded-2xl border border-blue-100 text-[#084b9a]">
                                            <div className="bg-white p-3 rounded-full shadow-sm"><formData.category.icon /></div>
                                            <div><p className="text-xs font-bold uppercase opacity-60">Categor√≠a</p><p className="font-black text-xl">{formData.category.label}</p></div>
                                        </div>
                                        <h3 className="font-bold text-gray-400 uppercase text-xs mb-4 ml-2">Selecciona la falla espec√≠fica</h3>
                                        <div className="space-y-3">
                                            {formData.category.subcategories.map(sub => (
                                                <button key={sub.id} onClick={() => { setFormData({...formData, subcategory: sub}); setStep(4); }} className="w-full bg-white p-5 rounded-2xl border-2 border-[#e5e7eb] hover:border-[#0b4d9a] hover:shadow-md transition-all flex items-center gap-4 text-left group">
                                                    <span className="text-3xl group-hover:scale-110 transition-transform">{sub.icon}</span> <span className="font-bold text-lg text-gray-700 group-hover:text-[#0b4d9a]">{sub.label}</span> <ChevronRight className="ml-auto text-gray-300 group-hover:text-[#0b4d9a]" />
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={() => setStep(2)} className="w-full py-4 mt-6 text-gray-400 font-bold hover:text-gray-600">Volver</button>
                                    </div>
                                )}
                                {step === 4 && (
                                    <div className="animate-fadeIn space-y-6">
                                        <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                                            <div className="flex justify-between border-b pb-4 mb-4">
                                                <div><p className="text-gray-400 font-bold text-xs uppercase">Unidad</p> <span className="font-black text-3xl text-[#084b9a]">{catalogs.units.find(u=>u.id==formData.unitId)?.unit_number}</span></div>
                                                <div className="text-right"><p className="text-gray-400 font-bold text-xs uppercase">Falla</p><div className="flex items-center justify-end gap-2 mt-1"><span className="text-2xl">{formData.subcategory.icon}</span> <span className="font-bold text-gray-700">{formData.subcategory.label}</span></div></div>
                                            </div>
                                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Prioridad</label><div className="flex gap-2">{['baja', 'normal', 'alta', 'urgente'].map(p => <button key={p} onClick={()=>setFormData({...formData, priority:p})} className={`flex-1 py-2 rounded-lg border uppercase text-xs font-bold transition-all ${formData.priority===p ? (p==='urgente'?'bg-red-500 text-white border-red-500':'bg-[#0b4d9a] text-white border-[#0b4d9a]') : 'bg-white border-gray-200 text-gray-400'}`}>{p}</button>)}</div></div>
                                        </div>
                                        <div><label className="block text-sm font-bold text-[#084b9a] uppercase mb-2 ml-1">Notas Adicionales</label><textarea className="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-2xl h-32 focus:bg-white focus:border-[#0b4d9a] outline-none transition-all text-lg" placeholder="Describe el problema..." value={formData.notes} onChange={e=>setFormData({...formData, notes:e.target.value})}></textarea></div>
                                        <div className="flex gap-4 mt-4">
                                            <button onClick={() => setStep(3)} className="flex-1 py-4 rounded-xl border-2 border-gray-200 font-bold text-gray-500 hover:bg-gray-50">Atr√°s</button>
                                            <button onClick={handleSubmit} className="flex-[2] py-4 rounded-xl bg-[#f5851f] text-white font-bold text-lg shadow-lg hover:bg-[#d97317] hover:shadow-xl transition-all">Confirmar Reporte</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TicketDetailView = ({ ticket, onBack, onSaveUpdate, onAssign, user, assignableUsers }) => {
            const [status, setStatus] = useState(ticket.status);
            const [followUp, setFollowUp] = useState('');
            const [assignTo, setAssignTo] = useState(ticket.assigned_to || '');
            const canAssign = user.role === 'admin' || user.role === 'moderator';
            const canEditStatus = user.role !== 'creator';
            const handleSave = () => { 
                if (canAssign && assignTo && assignTo != ticket.assigned_to) onAssign({ incident_id: ticket.id, assigned_to: assignTo });
                onSaveUpdate(ticket.id, status, followUp); 
                onBack(); 
            };

            return (
                <div className="flex flex-col h-full bg-[#f3f4f6] animate-fadeIn">
                    <div className="bg-white p-4 shadow-sm border-b flex justify-between items-center sticky top-0 z-10">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-500 font-bold hover:text-[#0b4d9a]"><ArrowLeft size={20} /> Volver</button>
                        <div className="text-right"><p className="text-xs text-gray-400 font-bold uppercase">Folio</p><p className="text-xl font-black text-[#084b9a]">#{ticket.id}</p></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 max-w-4xl mx-auto w-full space-y-6">
                        <div className="bg-white rounded-[2rem] shadow-sm border p-6 md:p-8 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-gray-50 rounded-full -mr-10 -mt-10 z-0"></div>
                            <div className="relative z-10">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                    <div>
                                        <div className="flex items-center gap-3 mb-2"><span className="bg-[#0b4d9a] text-white px-3 py-1 rounded-lg font-black text-2xl shadow-sm">{ticket.unitNumber}</span> <span className="font-bold text-gray-500 text-lg">{ticket.companyName}</span></div>
                                        <div className="text-gray-400 text-sm font-medium flex items-center gap-2"><Calendar size={14}/> {ticket.created_at?.substring(0,16)}</div>
                                        {/* NUEVO: Mostrar creador del reporte */}
                                        <div className="text-[#0b4d9a] text-sm font-bold mt-1">Reportado por: {ticket.creator_fullname || ticket.creator_username || 'Desconocido'}</div>
                                    </div>
                                    <div className={`px-4 py-2 rounded-xl text-sm font-black uppercase tracking-wide border-2 ${ticket.status==='abierto'?'bg-red-50 text-red-500 border-red-100':'bg-green-50 text-green-600 border-green-100'}`}>{ticket.status}</div>
                                </div>
                                <div className="flex items-start gap-4 mb-6 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                    <div className="text-5xl filter drop-shadow-sm">{ticket.subcategory?.icon}</div>
                                    <div>
                                        <p className="text-2xl font-bold text-gray-800 leading-tight">{ticket.subcategory?.label}</p>
                                        <p className="text-[#0b4d9a] font-medium">{ticket.category?.label}</p>
                                    </div>
                                </div>
                                {ticket.notes && <div className="text-gray-600 italic bg-yellow-50 p-4 rounded-xl border border-yellow-100">"{ticket.notes}"</div>}
                                {ticket.assigned_username && <div className="mt-6 inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-[#0b4d9a] rounded-full font-bold text-sm"><UserCheck size={16}/> Asignado a: {ticket.assigned_username}</div>}
                            </div>
                        </div>

                        {canEditStatus && (
                            <div className="bg-white rounded-[2rem] shadow-lg border border-blue-100 p-6 md:p-8">
                                <h3 className="font-bold text-[#0b4d9a] text-lg mb-6 flex items-center gap-2 pb-4 border-b border-gray-100"><Wrench size={24}/> Panel de Gesti√≥n</h3>
                                {canAssign && (
                                    <div className="mb-6">
                                        <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Asignar T√©cnico</label>
                                        <select className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 font-medium focus:border-[#0b4d9a] outline-none transition-colors" value={assignTo} onChange={e=>setAssignTo(e.target.value)}>
                                            <option value="">-- Seleccionar T√©cnico --</option>
                                            {/* Mostrar mensaje si no hay t√©cnicos */}
                                            {assignableUsers.length > 0 ? (
                                                assignableUsers.map(u => (
                                                    <option key={u.id} value={u.id}>{u.full_name || u.username}</option>
                                                ))
                                            ) : (
                                                <option disabled>No hay t√©cnicos disponibles (Verifica usuarios con rol 'assigned')</option>
                                            )}
                                        </select>
                                    </div>
                                )}
                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Actualizar Estatus</label>
                                    <div className="flex gap-3">
                                        {['abierto','en_proceso','resuelto'].map(s=>(
                                            <button key={s} onClick={()=>setStatus(s)} className={`flex-1 py-3 rounded-xl border-2 text-sm font-bold uppercase transition-all ${status===s ? (s==='resuelto'?'bg-green-500 text-white border-green-500': s==='en_proceso'?'bg-yellow-400 text-white border-yellow-400':'bg-red-500 text-white border-red-500') : 'bg-white border-gray-200 text-gray-400 hover:border-gray-300'}`}>{s.replace('_',' ')}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Agregar Bit√°cora</label>
                                    <textarea className="w-full p-4 border-2 border-gray-200 rounded-xl h-24 bg-gray-50 focus:bg-white focus:border-[#0b4d9a] outline-none" placeholder="Describe el avance o soluci√≥n..." value={followUp} onChange={e=>setFollowUp(e.target.value)}></textarea>
                                </div>
                                <button onClick={handleSave} className="w-full bg-[#f5851f] text-white font-bold text-lg py-4 rounded-xl shadow-lg hover:bg-[#d97317] transition-all">Guardar Cambios</button>
                            </div>
                        )}

                        {ticket.history?.length > 0 && (
                            <div className="pb-10">
                                <h4 className="font-bold text-gray-400 text-xs uppercase mb-4 ml-2 tracking-wider">Historial de Movimientos</h4>
                                <div className="space-y-3">
                                    {ticket.history.map((h,i)=>(
                                        <div key={i} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex gap-4 items-start">
                                            <div className="mt-1 text-[#0b4d9a] bg-blue-50 p-2 rounded-full"><Clock size={16} /></div>
                                            <p className="text-gray-600 text-sm leading-relaxed pt-1">{h}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DashboardScreen = ({ incidents, mode, onBack, onUpdateStatus, onAssign, user, assignableUsers }) => {
            const [selectedTicket, setSelectedTicket] = useState(null);
            if (selectedTicket) return <TicketDetailView ticket={selectedTicket} onBack={()=>setSelectedTicket(null)} onSaveUpdate={onUpdateStatus} onAssign={onAssign} user={user} assignableUsers={assignableUsers} />;
            
            // T√≠tulo seg√∫n el modo
            let title = 'Listado General';
            if (mode === 'status_created') title = 'Mis Reportes Creados';
            else if (mode === 'status_assigned') title = 'Mis Tareas Asignadas';

            return (
                <div className="min-h-screen bg-[#f3f4f6] flex flex-col">
                    <Header title={title} subtitle={mode === 'admin_dashboard' ? 'Gesti√≥n Global' : 'Consulta'} onBack={onBack} user={user} />
                    <div className="flex-1 p-4 max-w-5xl mx-auto w-full overflow-y-auto pb-20">
                        {incidents.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                                <div className="bg-white p-6 rounded-full shadow-sm mb-4"><LayoutGrid size={48} className="opacity-20"/></div>
                                <p className="font-medium">No hay reportes para mostrar</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {incidents.map(ticket => (
                                    <div key={ticket.id} onClick={()=>setSelectedTicket(ticket)} className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-5 cursor-pointer hover:border-[#0b4d9a] hover:shadow-md transition-all group">
                                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-inner ${ticket.category?.color || 'bg-gray-100'}`}>{ticket.category?.icon && <ticket.category.icon size={28} />}</div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-black text-lg text-[#084b9a]">Unidad {ticket.unitNumber}</span>
                                                <span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase border ${ticket.status==='abierto'?'text-red-600 border-red-100 bg-red-50':'text-green-600 border-green-100 bg-green-50'}`}>{ticket.status}</span>
                                            </div>
                                            <p className="text-sm font-bold text-gray-700 flex items-center gap-2 truncate"><span>{ticket.subcategory?.icon}</span> {ticket.subcategory?.label}</p>
                                            <p className="text-xs text-gray-400 mt-1 truncate">Creado: {ticket.created_at?.substring(0,10)}</p>
                                        </div>
                                        <div className="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-[#0b4d9a] group-hover:text-white transition-colors">
                                            <ChevronRight size={18} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [catalogs, setCatalogs] = useState({ units: [], operators: [], companies: [] });
            const [incidents, setIncidents] = useState([]);
            const [incidentCatalog, setIncidentCatalog] = useState([]);
            const [assignableUsers, setAssignableUsers] = useState([]);

            // Funci√≥n centralizada para cargar datos
            const loadData = async () => {
                // Solo cargamos cat√°logos generales una vez si ya est√°n
                if (catalogs.units.length === 0) {
                    const cats = await ApiService.fetchCatalogs();
                    const dynCat = await ApiService.fetchDynamicCatalog(); 
                    // Carga robusta de usuarios asignables
                    const aUsers = await ApiService.fetchAssignableUsers();
                    setCatalogs(cats);
                    setIncidentCatalog(dynCat);
                    setAssignableUsers(aUsers);
                }
            };

            // Funci√≥n para cargar incidentes seg√∫n la vista seleccionada
            const loadIncidentsForView = async (viewName) => {
                if (!user) return;
                
                let filterMode = 'default';
                if (viewName === 'status_created') filterMode = 'created_by_me';
                else if (viewName === 'status_assigned') filterMode = 'assigned_to_me'; // Podr√≠amos implementar esto en PHP si queremos ser estrictos, o dejar que el rol lo maneje por defecto
                
                const incs = await ApiService.fetchIncidents(incidentCatalog, user, filterMode);
                setIncidents(incs);
            };

            useEffect(() => {
                if (user) {
                    loadData();
                    setView('menu');
                }
            }, [user]);

            // Efecto para recargar incidentes cuando cambia la vista
            useEffect(() => {
                if (user && (view.startsWith('status') || view === 'admin_dashboard')) {
                    loadIncidentsForView(view);
                }
            }, [view, user]);

            const handleLogout = () => { setUser(null); setView('login'); };
            
            const handleCreate = async (data) => { 
                await ApiService.createIncident(data); 
                // No recargamos incidentes aqu√≠, se recargar√°n al cambiar de vista
                setView('menu'); 
            };
            
            const handleStatusUpdate = async (id, status, note) => { 
                await ApiService.updateStatus(id, status, note); 
                loadIncidentsForView(view); // Recargar la vista actual
            };
            
            const handleAssign = async (data) => { 
                await ApiService.assignIncident(data); 
                loadIncidentsForView(view); 
            };

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <React.Fragment>
                    {view === 'menu' && <MainMenu user={user} onNavigate={(t) => t === 'logout' ? handleLogout() : setView(t)} />}
                    
                    {view === 'create' && <CreateTicket user={user} onCancel={() => setView('menu')} onSubmit={handleCreate} catalogs={catalogs} incidentCatalog={incidentCatalog} onLogout={handleLogout} />}
                    
                    {(view === 'status_created' || view === 'status_assigned' || view === 'admin_dashboard') && 
                        <DashboardScreen mode={view} incidents={incidents} onBack={() => setView(view==='admin_dashboard'?'admin_menu':'menu')} onUpdateStatus={handleStatusUpdate} onAssign={handleAssign} user={user} assignableUsers={assignableUsers} onLogout={handleLogout} />
                    }
                    
                    {view === 'admin_menu' && <AdminMenu onNavigate={setView} user={user} onLogout={handleLogout} />}
                    {view === 'admin_users' && <UserManagement onBack={() => setView('admin_menu')} user={user} onLogout={handleLogout} />}
                    {view === 'admin_catalog' && <CatalogConfig catalog={incidentCatalog} onReload={async ()=>{ const c = await ApiService.fetchDynamicCatalog(); setIncidentCatalog(c); }} onBack={() => setView('admin_menu')} user={user} onLogout={handleLogout} />}
                </React.Fragment>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>